---
title: "Housing Price Regresison"
author: "Joey Bringley"
date: "October 6, 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, results='hide', warning=FALSE}
library(caret)
library(e1071)
library(gridExtra)
```

## Load in the data
```{r}
setwd('~/ML/HousingPrices')
train <- read.csv('train.csv', stringsAsFactors=F)
test <- read.csv('test.csv', stringsAsFactors=F)
full <- rbind(within(train, rm('Id', 'SalePrice')), within(test, rm('Id')))
```

```{r}
dim(train)
```

```{r}
str(train)
```

```{r}
sparsity <- round(sum(is.na(train))/(nrow(train)*ncol(train))*100, digits=2)
sparsity ## sparsity is around 6%
```

## Examine the missing data
```{r}
null_counts <- colSums(sapply(full, is.na))
null_features <- null_counts[null_counts > 0]
sort(null_features, decreasing=T)
```

## Examine Numeric Features
```{r}
feature_classes <- sapply(full, class)
numeric_features <- names(feature_classes[feature_classes != "character"])
```

Compute skewness for each numeric feature
```{r}
feature_skewness <- sapply(numeric_features, function(x){
  skewness(full[,x], na.rm=TRUE)
})
```

Keep only features that exceed a threshold, here we will use 0.75
Transform skewed features with transformation: log(x+1)
```{r}
## keep only features that exceed a threshold, here we will use 0.75
feature_skewness <- feature_skewness[feature_skewness > 0.75]
for(i in names(feature_skewness)){
  full[, i] <- log(full[, i] + 1)
}
```

Use the mean to handle null cases for numeric features 
```{r}
for(j in numeric_features){
  avg <- mean(full[, j], na.rm=T)
  full[is.na(full[, j]), j] <- avg
}
```


## Examine Categorical Features 
Use caret dummyVar functions for hot one encoding for categorical features
```{r}
categorical_features <- names(feature_classes[feature_classes=="character"])

dummies <- dummyVars(~., full[categorical_features])
cat_one_hot <- predict(dummies, full[categorical_features])
cat_one_hot[is.na(cat_one_hot)] <- 0 # for any level that was NA, set to zero
```

## Examine Predictor
```{r}
plot1 <- qplot(train$SalePrice, geom="histogram", xlab="Sale Price",
               ylab="Count", main="Sale Price Distribution",
               fill=I('blue'), col=I('red'), alpha=I(.2))
plot2 <- qplot(log(train$SalePrice+1), geom="histogram", xlab="Sale Price", 
               ylab="Count", main="Sale Price Distribution with Log Transformation",
               fill=I('blue'), col=I('red'), alpha=I(.2))
grid.arrange(plot1, plot2, ncol=2)

skewness(train$SalePrice)
```

Since we see the distribution is skewed right, perform log transformation
```{r}
train$SalePrice <- log(train$SalePrice + 1)
```

## Merge Pre-Processed Data ##
```{r}
final <- cbind(full[numeric_features], cat_one_hot)
training <- final[1:nrow(train), ]
testing <- final[(nrow(train)+1):nrow(full), ]
y <- train$SalePrice
sum(is.na(final)) ## make sure dataframe contains zero nulls
```

## Model Setup ##
```{r}
train_ctrl <- trainControl(method="repeatedcv",
                           number=10, 
                           repeats=3,
                           verboseIter=FALSE)
```

## Elastic Net Regression
Elastic Net is used here because it solves the limiations of LASSO and Ridge regression while also including them as special cases (when alpha equals zero or one).
```{r, warning=FALSE}
lambda_grid <- seq(0, 1, by=0.001)
alpha_grid <- seq(0, 1, by=0.1)
srch_grid <- expand.grid(.alpha=alpha_grid, .lambda=lambda_grid)
## model
set.seed(5594)
elastic_fit <- train(x=training,
             y=y,
             method='glmnet',
             tuneGrid=srch_grid,
             trControl=train_ctrl,
             standardize=TRUE)
plot(elastic_fit)
elastic_fit$bestTune
mean(elastic_fit$resample$RMSE)
```

### Predictions and Submission
```{r}
elastic_preds <- exp(predict(elastic_fit, newdata=testing)) -1
elastic_sol <- data.frame(Id=as.integer(rownames(testing)), SalePrice=elastic_preds)
write.csv(elastic_sol, "elastic_solution.csv", row.names=F)
```